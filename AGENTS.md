# AGENTS.md - Guidelines for Agentic Coding Agents

This file provides comprehensive guidelines for AI coding agents (including Claude, Cursor, Copilot, etc.) working in this repository.

---

## ğŸ— **Build & Test Commands**

### Linting
```bash
# PHP linting (fast, focused on syntax)
composer exec --prefer-source phpcs --standard=PSR12 --report=json src/ | jq -r '.files.messages | map(select(.severity >= 5)) | flatten | length'

# Full PHPStan analysis (static analysis)
php -d memory_limit=2G vendor/bin/phpstan analyse --configuration phpstan.neon --memory-limit=2G src/

# Run specific component tests
php bin/phpunit tests/Unit/Entity/LyricsTest.php

# Single file quick syntax check
php -l src/Entity/Lyrics.php
```

### Code Style

* Use Symfony 8, PHP 8.4
* Leverage #[Argument] and #[Option] in console commands, using __invoke()
* Never add the description: to the console attributes, since it is the first property.  Don't add the name: unless it's different than the PHP name

Do this:

#[Argument("reset the database first")] bool $reset = false,

Don't do this:

#[Argument(description: "reset the database first", name: 'reset')] bool $reset = false,

Assume the latest libraries.

```bash
# Fix code style issues automatically
composer exec --prefer-source phpcbf src/

# Check formatting for specific patterns
grep -r "function.*{" src/ --include="*.php"
```

---

## ğŸ”§ **Code Style Guidelines**

### Import Organization
```php
<?php

// Standard imports (Alphabetical order by category)
use Doctrine\ORM\Mapping\Column;
use Doctrine\ORM\Mapping\Entity;
use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;
use Symfony\Component\HttpFoundation\Response;
use Symfony\Component\Routing\Attribute\Route;

// Third-party imports at bottom
use App\Service\SomeService;
use GuzzleHttp\Client;
```

### Naming Conventions
```php
// Classes: PascalCase (LyricsRepository, MusicDisplayField)
// Methods: camelCase (getUserData(), processRequest())
// Properties: camelCase (private string $userName)
// Constants: UPPER_SNAKE_CASE (private const MAX_RETRIES = 3)
// Files: kebab-case for non-classes (user-service.php, music-display-controller.js)
```

### Type Declarations & PHP 8.5+ Features
```php
<?php

// Use property hooks for computed values
public string $fullName { get => $this->firstName . ' ' . $this->lastName; }

// Use readonly properties where possible
public function __construct(
    private readonly HttpClientInterface $httpClient,
    private readonly LoggerInterface $logger
) {}

// Use union types for flexibility
public ?string $description = null;
public array|int $metadata = [];

// Use short match expressions
$status = match ($request->getMethod()) {
    'GET' => 'processing',
    'POST' => 'completed',
    default => 'unknown'
};
```

### Error Handling
```php
<?php

// Always type hint exceptions
try {
    $result = $this->someOperation();
} catch (\InvalidArgumentException $e) {
    $this->logger->error('Invalid argument: ' . $e->getMessage());
    throw $e;
} catch (\Exception $e) {
    $this->logger->error('Operation failed: ' . $e->getMessage());
    return new Response(['error' => $e->getMessage()], 500);
}
```

### Database & Entity Guidelines
```php
<?php

// Use property hooks instead of getters/setters for simple computed properties
#[Column(type: Types::TEXT)]
public string $firstName { set => $this->firstName = trim($value); }

// Add comprehensive documentation blocks
/**
 * Handles user authentication and session management.
 *
 * @package App\Service
 * @author Generated by AGENTS.md guidelines
 */
class UserService
{
    // Implementation
}
```

---

## ğŸ¯ **Architecture Patterns**

### Service Layer
```php
<?php

// Interface-first design
interface MusicParserInterface
{
    public function parse(string $content): Song;
}

// Dependency injection with constructor promotion
class ChordProService implements MusicParserInterface
{
    public function __construct(
        private readonly LoggerInterface $logger,
        private readonly HttpClientInterface $httpClient
    ) {}
}
```

### Controller Best Practices
```php
<?php

// Single responsibility - one action per controller method
#[Route('/api/users/{id}', methods: ['GET'])]
public function getUser(int $id): Response
{
    $user = $this->userRepository->find($id);
    if (!$user) {
        return new Response(['error' => 'User not found'], 404);
    }
    return new Response($user->toArray());
}

// Use DTOs for API responses
class UserResponse
{
    public function __construct(
        public readonly int $id,
        public readonly string $email,
        public readonly string $name
    ) {}
}
```

---

## ğŸ“ **File Organization**

```
src/
â”œâ”€â”€ Controller/           # HTTP controllers, thin, focused on HTTP concerns
â”œâ”€â”€ Entity/              # Doctrine entities, business objects
â”œâ”€â”€ Service/             # Business logic, external integrations
â”œâ”€â”€ Repository/           # Data access layer
â”œâ”€â”€ Field/               # Custom EasyAdmin fields
â”œâ”€â”€ Form/                # Symfony form types
â””â”€â”€ Event/                # Event listeners and subscribers
```

### Template Guidelines
```twig
{# Use extends for proper inheritance}
{% extends '@EasyAdmin/page/content.html.twig' %}

{# Block organization}
{% block content %} {% endblock %}
{% block page_title %} {{ page.title }} {% endblock %}

{# Stimulus integration - use helper functions}
<div {{ stimulus_controller('music-display', {
    'url': url,
    'width': 800,
    'height': 600
}) }}></div>
```

---

## ğŸ§ª **Testing Strategy**

### Unit Tests
```php
<?php

// Test property hooks thoroughly
class LyricsEntityTest extends TestCase
{
    public function testTitleFromParsedSong(): void
    {
        $lyrics = new Lyrics();
        $lyrics->text = '{title: Test Song}{artist: Test Artist}';

        $this->assertEquals('Test Song', $lyrics->title);
        $this->assertEquals('Test Artist', $lyrics->artist);
    }
}
```

### Integration Tests
```bash
# Test specific routes
php bin/console debug:router --match-route=/lyrics/test/raw

# Run database migrations in test environment
DATABASE_URL="sqlite:///:memory:" php bin/console doctrine:migrations:migrate --env=test

# Test API endpoints
curl -X GET http://localhost:8000/api/lyrics/test/raw -H "Accept: text/plain"
```

---

## ğŸ” **Debugging & Troubleshooting**

### Common Debug Commands
```bash
# Clear all caches
php bin/console cache:clear
php bin/console cache:pool:clear --pool=cache.app

# Debug specific routes
php bin/console debug:router lyrics_raw
php bin/console debug:container LyricsController

# Profile specific requests
php bin/console debug:config --env=dev main

# Database inspection
php bin/console doctrine:schema:validate
php bin/console doctrine:migrations:diff
```

### Log Analysis
```bash
# Track error patterns
tail -f var/log/dev.log | grep "ERROR" | tail -20

# Monitor performance
grep "memory_get_peak_usage" var/log/dev.log | tail -10

# Debug specific entities
php bin/console debug:autowiring LyricsController
```

---

## ğŸš€ **Performance Guidelines**

### Memory Management
```php
<?php

// Stream processing for large files
foreach ($this->getLargeDataSet() as $item) {
    $this->processItem($item);
    // Process single item at a time
    unset($item); // Free memory immediately
}

// Use generators for memory efficiency
function generateLargeArray(): \Generator
{
    for ($i = 0; $i < 100000; $i++) {
        yield ['id' => $i, 'data' => random_bytes(1024)];
    }
}
```

### Database Optimization
```php
<?php

// Use proper indexing for frequently queried fields
#[Index(fields: ['title', 'artist', 'code'])]
class Lyrics
{
    // Implementation
}

// Batch processing for bulk operations
public function bulkInsert(array $lyrics): void
{
    $this->entityManager->beginTransaction();
    try {
        foreach (array_chunk($lyrics, 1000) as $chunk) {
            foreach ($chunk as $lyric) {
                $this->entityManager->persist($lyric);
            }
            $this->entityManager->flush();
            $this->entityManager->clear(); // Free memory
        }
        $this->entityManager->commit();
    } catch (\Exception $e) {
        $this->entityManager->rollback();
        throw $e;
    }
}
```

---

## ğŸ“‹ **Documentation Standards**

### PHPDoc Standards
```php
<?php

/**
 * Comprehensive documentation block
 *
 * Handles ChordPro parsing and music sheet generation.
 *
 * @package App\Service
 * @author Generated by AGENTS.md guidelines
 * @since 1.0.0
 *
 * @param string $content The ChordPro content to parse
 * @param array $options Parsing options for customization
 *
 * @return Song Parsed song object with metadata and chords
 *
 * @throws \InvalidArgumentException When content is empty
 * @throws \RuntimeException When parsing fails
 */
public function parse(string $content, array $options = []): Song
{
    // Implementation
}
```

### Comments Guidelines
```php
<?php

// Business logic: Explain WHY, not WHAT
if ($user->hasPermission('edit')) {
    // User can edit because they have the 'edit' permission
    $this->updateSong($song);
} else {
    // User cannot edit due to missing permissions
    throw new AccessDeniedException('Edit permission required');
}

// TODO comments with actionable items
// TODO: Add validation for ChordPro format edge cases (issue #123)
// TODO: Implement caching for parsed songs (performance improvement)

// Inline comments for complex logic
if ($this->isComplexCondition($input)) {
    // Handle edge case where user has multiple roles and mixed permissions
    // Check each role's permissions and aggregate results
    $permissions = $this->aggregatePermissions($user->getRoles());
    return $this->checkAccessLevel($permissions, $requiredLevel);
}
```

---

## ğŸ”Œ **External Services & APIs**

### HTTP Client Usage
```php
<?php

// Proper error handling with retry logic
try {
    $response = $this->httpClient->request('GET', $url);

    if ($response->getStatusCode() >= 500) {
        // Retry logic for server errors
        throw new ServiceUnavailableException('External service temporarily unavailable');
    }

    return $response->toArray();
} catch (\GuzzleHttp\Exception\ConnectException $e) {
    $this->logger->error('Network error: ' . $e->getMessage());
    throw new ServiceUnavailableException('Network connectivity issue');
}
```

---

## âš¡ **Cursor Rules & Copilot Instructions**

This repository follows additional guidelines defined in:
- `.cursor/rules/` - For Cursor-specific rules and preferences
- `.github/copilot-instructions.md` - For GitHub Copilot specific instructions

---

## ğŸ“Š **Key Metrics to Monitor**

### Performance Metrics
- Response time < 200ms for API endpoints
- Memory usage < 64MB for background processes
- Database queries < 10 per request for admin pages
- Asset loading time < 2s for stimulus controllers

### Code Quality Metrics
- Test coverage > 80%
- PHPStan level 0 (no errors)
- PHPCS compliance > 95%
- Maximum cyclomatic complexity < 10 per method

### User Experience Metrics
- Admin page load time < 1s
- Mobile responsiveness score > 90%
- Accessibility compliance (WCAG 2.1 AA)

---

## ğŸ›  **Troubleshooting Checklist**

Before deploying changes, verify:

- [ ] All PHP syntax checks pass: `php -l src/`
- [ ] Static analysis passes: `php bin/phpstan analyse src/`
- [ ] Code style compliant: `composer exec phpcs src/`
- [ ] Tests pass: `php bin/phpunit`
- [ ] Database migrations created and tested
- [ ] Cache cleared and warmed
- [ ] Routes verified: `php bin/console debug:router`
- [ ] External services responding
- [ ] Security audit completed

---

## ğŸ“ **Notes for This Repository**

This project uses:
- **PHP 8.5+** with property hooks
- **Symfony 6.x** with modern features
- **Doctrine ORM** with proper entity relationships
- **EasyAdmin** for administration interface
- **Stimulus** for dynamic frontend interactions
- **ChordPro** parsing for music notation
- **MeiliSearch** for search functionality

When making changes:
1. Run the lint commands in the "Build & Test Commands" section
2. Follow the naming conventions and code patterns
3. Add comprehensive tests for new functionality
4. Update this AGENTS.md file when adding new patterns
5. Consider performance implications for data processing

Generated for agentic development excellence. ğŸš€
