{% set slotOptions = {
    NAVBAR_MENU: {
        x: null,
        frontPage: true
    },
    PAGE_ACTIONS: {
        audio: audio,
        song: audio.song
    },
    BREADCRUMBS: {
        audio: audio,
        song: audio.song
    }
} %}
<twig:tabler:page :title="audio.title"
                  :slotOptions="slotOptions"
>
    <div class="card mb-4">
        <div class="card-body">
            <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center gap-3">
                <div>
                    <h2 class="mb-1">{{ audio.title }}</h2>
                    <div class="text-muted">{{ audio.song.title }}</div>
                </div>
                <div class="text-muted small">
                    <span class="me-3"><strong>Format:</strong> {{ audio.format }}</span>
                    <span><strong>Variant:</strong> {{ audio.variant ?: 'standard' }}</span>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4 position-sticky" style="top: 0; z-index: 1020;">
        <div class="card-body">
            <audio controls preload="metadata" style="width: 100%;">
                <source src="{{ path('audio_file', { id: audio.id }) }}" type="audio/mpeg">
                Your browser does not support the audio element.
            </audio>
        </div>
    </div>

    <twig:divider />

    <div class="row mb-4">
        <div class="col-lg-5">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Lyrics</h3>
                </div>
                <div class="card-body" style="max-height: 70vh; overflow: auto;">
                    <div data-lyrics role="presentation">
                        {% if segments|length %}
                            {% for segment in segments %}
                                <p class="mb-3" data-start="{{ segment.start }}" data-end="{{ segment.end }}">
                                    {{ segment.text }}
                                </p>
                            {% endfor %}
                        {% else %}
                            <div class="text-muted">No lyrics found yet.</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-7">
            <div class="card">
                <div class="card-header d-flex align-items-center justify-content-between">
                    <h3 class="card-title">Score</h3>
                    <a class="btn btn-sm btn-outline-secondary" href="{{ path('audio_musicxml', { id: audio.id }) }}" target="_blank">MusicXML</a>
                </div>
                <div class="card-body" style="max-height: 70vh; overflow: auto;">
                    {% set _sc = 'music' %}
                    {% set url = path('audio_musicxml', { id: audio.id }) %}
                    <div {{ stimulus_controller(_sc, {
                        'url': url,
                        'format': 'xml',
                        'width': 800,
                        'height': 600
                    }) }} style="min-height: 520px; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 1rem;"
                         class="text-center text-muted">
                        <div class="spinner-border" role="status" {{ stimulus_target(_sc, 'spinner') }}>
                            <span class="visually-hidden">Loading music...</span>
                        </div>
                        <div {{ stimulus_target(_sc, 'display') }}>
                            <p class="mt-2">Loading sheet music...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        (function() {
            const audio = document.querySelector('audio')
            const container = document.querySelector('[data-lyrics]')
            if (!audio || !container) return

            const lines = Array.from(container.querySelectorAll('[data-start]'))
            if (!lines.length) return

            const highlight = (time) => {
                let active = null
                for (const line of lines) {
                    const start = parseFloat(line.dataset.start || '0')
                    const end = parseFloat(line.dataset.end || '0')
                    if (time >= start && time <= end) {
                        active = line
                        break
                    }
                }

                lines.forEach((line) => line.classList.remove('text-primary', 'fw-semibold'))
                if (active) {
                    active.classList.add('text-primary', 'fw-semibold')
                    active.scrollIntoView({ block: 'center', behavior: 'smooth' })
                }
            }

            audio.addEventListener('timeupdate', () => highlight(audio.currentTime))
        })()
    </script>
</twig:tabler:page>
